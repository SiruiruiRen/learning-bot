/*
 * ATTENTION: An "eval-source-map" devtool has been used.
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file with attached SourceMaps in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
(() => {
var exports = {};
exports.id = "app/api/chat/route";
exports.ids = ["app/api/chat/route"];
exports.modules = {

/***/ "next/dist/compiled/next-server/app-page.runtime.dev.js":
/*!*************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-page.runtime.dev.js" ***!
  \*************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/compiled/next-server/app-page.runtime.dev.js");

/***/ }),

/***/ "next/dist/compiled/next-server/app-route.runtime.dev.js":
/*!**************************************************************************!*\
  !*** external "next/dist/compiled/next-server/app-route.runtime.dev.js" ***!
  \**************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/compiled/next-server/app-route.runtime.dev.js");

/***/ }),

/***/ "../app-render/after-task-async-storage.external":
/*!***********************************************************************************!*\
  !*** external "next/dist/server/app-render/after-task-async-storage.external.js" ***!
  \***********************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/server/app-render/after-task-async-storage.external.js");

/***/ }),

/***/ "../app-render/work-async-storage.external":
/*!*****************************************************************************!*\
  !*** external "next/dist/server/app-render/work-async-storage.external.js" ***!
  \*****************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/server/app-render/work-async-storage.external.js");

/***/ }),

/***/ "./work-unit-async-storage.external":
/*!**********************************************************************************!*\
  !*** external "next/dist/server/app-render/work-unit-async-storage.external.js" ***!
  \**********************************************************************************/
/***/ ((module) => {

"use strict";
module.exports = require("next/dist/server/app-render/work-unit-async-storage.external.js");

/***/ }),

/***/ "buffer":
/*!*************************!*\
  !*** external "buffer" ***!
  \*************************/
/***/ ((module) => {

"use strict";
module.exports = require("buffer");

/***/ }),

/***/ "crypto":
/*!*************************!*\
  !*** external "crypto" ***!
  \*************************/
/***/ ((module) => {

"use strict";
module.exports = require("crypto");

/***/ }),

/***/ "events":
/*!*************************!*\
  !*** external "events" ***!
  \*************************/
/***/ ((module) => {

"use strict";
module.exports = require("events");

/***/ }),

/***/ "http":
/*!***********************!*\
  !*** external "http" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("http");

/***/ }),

/***/ "https":
/*!************************!*\
  !*** external "https" ***!
  \************************/
/***/ ((module) => {

"use strict";
module.exports = require("https");

/***/ }),

/***/ "net":
/*!**********************!*\
  !*** external "net" ***!
  \**********************/
/***/ ((module) => {

"use strict";
module.exports = require("net");

/***/ }),

/***/ "punycode":
/*!***************************!*\
  !*** external "punycode" ***!
  \***************************/
/***/ ((module) => {

"use strict";
module.exports = require("punycode");

/***/ }),

/***/ "stream":
/*!*************************!*\
  !*** external "stream" ***!
  \*************************/
/***/ ((module) => {

"use strict";
module.exports = require("stream");

/***/ }),

/***/ "tls":
/*!**********************!*\
  !*** external "tls" ***!
  \**********************/
/***/ ((module) => {

"use strict";
module.exports = require("tls");

/***/ }),

/***/ "url":
/*!**********************!*\
  !*** external "url" ***!
  \**********************/
/***/ ((module) => {

"use strict";
module.exports = require("url");

/***/ }),

/***/ "zlib":
/*!***********************!*\
  !*** external "zlib" ***!
  \***********************/
/***/ ((module) => {

"use strict";
module.exports = require("zlib");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!":
/*!******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D! ***!
  \******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   patchFetch: () => (/* binding */ patchFetch),\n/* harmony export */   routeModule: () => (/* binding */ routeModule),\n/* harmony export */   serverHooks: () => (/* binding */ serverHooks),\n/* harmony export */   workAsyncStorage: () => (/* binding */ workAsyncStorage),\n/* harmony export */   workUnitAsyncStorage: () => (/* binding */ workUnitAsyncStorage)\n/* harmony export */ });\n/* harmony import */ var next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/dist/server/route-modules/app-route/module.compiled */ \"(rsc)/./node_modules/next/dist/server/route-modules/app-route/module.compiled.js\");\n/* harmony import */ var next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__);\n/* harmony import */ var next_dist_server_route_kind__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! next/dist/server/route-kind */ \"(rsc)/./node_modules/next/dist/server/route-kind.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! next/dist/server/lib/patch-fetch */ \"(rsc)/./node_modules/next/dist/server/lib/patch-fetch.js\");\n/* harmony import */ var next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2___default = /*#__PURE__*/__webpack_require__.n(next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__);\n/* harmony import */ var _Users_sirui_Desktop_mybot_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! ./app/api/chat/route.ts */ \"(rsc)/./app/api/chat/route.ts\");\n\n\n\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new next_dist_server_route_modules_app_route_module_compiled__WEBPACK_IMPORTED_MODULE_0__.AppRouteRouteModule({\n    definition: {\n        kind: next_dist_server_route_kind__WEBPACK_IMPORTED_MODULE_1__.RouteKind.APP_ROUTE,\n        page: \"/api/chat/route\",\n        pathname: \"/api/chat\",\n        filename: \"route\",\n        bundlePath: \"app/api/chat/route\"\n    },\n    resolvedPagePath: \"/Users/sirui/Desktop/mybot/app/api/chat/route.ts\",\n    nextConfigOutput,\n    userland: _Users_sirui_Desktop_mybot_app_api_chat_route_ts__WEBPACK_IMPORTED_MODULE_3__\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return (0,next_dist_server_lib_patch_fetch__WEBPACK_IMPORTED_MODULE_2__.patchFetch)({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\n\n\n//# sourceMappingURL=app-route.js.map//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiKHJzYykvLi9ub2RlX21vZHVsZXMvbmV4dC9kaXN0L2J1aWxkL3dlYnBhY2svbG9hZGVycy9uZXh0LWFwcC1sb2FkZXIvaW5kZXguanM/bmFtZT1hcHAlMkZhcGklMkZjaGF0JTJGcm91dGUmcGFnZT0lMkZhcGklMkZjaGF0JTJGcm91dGUmYXBwUGF0aHM9JnBhZ2VQYXRoPXByaXZhdGUtbmV4dC1hcHAtZGlyJTJGYXBpJTJGY2hhdCUyRnJvdXRlLnRzJmFwcERpcj0lMkZVc2VycyUyRnNpcnVpJTJGRGVza3RvcCUyRm15Ym90JTJGYXBwJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmcm9vdERpcj0lMkZVc2VycyUyRnNpcnVpJTJGRGVza3RvcCUyRm15Ym90JmlzRGV2PXRydWUmdHNjb25maWdQYXRoPXRzY29uZmlnLmpzb24mYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEISIsIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7OztBQUErRjtBQUN2QztBQUNxQjtBQUNBO0FBQzdFO0FBQ0E7QUFDQTtBQUNBLHdCQUF3Qix5R0FBbUI7QUFDM0M7QUFDQSxjQUFjLGtFQUFTO0FBQ3ZCO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQ0E7QUFDQSxZQUFZO0FBQ1osQ0FBQztBQUNEO0FBQ0E7QUFDQTtBQUNBLFFBQVEsc0RBQXNEO0FBQzlEO0FBQ0EsV0FBVyw0RUFBVztBQUN0QjtBQUNBO0FBQ0EsS0FBSztBQUNMO0FBQzBGOztBQUUxRiIsInNvdXJjZXMiOlsiIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcFJvdXRlUm91dGVNb2R1bGUgfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9yb3V0ZS1tb2R1bGVzL2FwcC1yb3V0ZS9tb2R1bGUuY29tcGlsZWRcIjtcbmltcG9ydCB7IFJvdXRlS2luZCB9IGZyb20gXCJuZXh0L2Rpc3Qvc2VydmVyL3JvdXRlLWtpbmRcIjtcbmltcG9ydCB7IHBhdGNoRmV0Y2ggYXMgX3BhdGNoRmV0Y2ggfSBmcm9tIFwibmV4dC9kaXN0L3NlcnZlci9saWIvcGF0Y2gtZmV0Y2hcIjtcbmltcG9ydCAqIGFzIHVzZXJsYW5kIGZyb20gXCIvVXNlcnMvc2lydWkvRGVza3RvcC9teWJvdC9hcHAvYXBpL2NoYXQvcm91dGUudHNcIjtcbi8vIFdlIGluamVjdCB0aGUgbmV4dENvbmZpZ091dHB1dCBoZXJlIHNvIHRoYXQgd2UgY2FuIHVzZSB0aGVtIGluIHRoZSByb3V0ZVxuLy8gbW9kdWxlLlxuY29uc3QgbmV4dENvbmZpZ091dHB1dCA9IFwiXCJcbmNvbnN0IHJvdXRlTW9kdWxlID0gbmV3IEFwcFJvdXRlUm91dGVNb2R1bGUoe1xuICAgIGRlZmluaXRpb246IHtcbiAgICAgICAga2luZDogUm91dGVLaW5kLkFQUF9ST1VURSxcbiAgICAgICAgcGFnZTogXCIvYXBpL2NoYXQvcm91dGVcIixcbiAgICAgICAgcGF0aG5hbWU6IFwiL2FwaS9jaGF0XCIsXG4gICAgICAgIGZpbGVuYW1lOiBcInJvdXRlXCIsXG4gICAgICAgIGJ1bmRsZVBhdGg6IFwiYXBwL2FwaS9jaGF0L3JvdXRlXCJcbiAgICB9LFxuICAgIHJlc29sdmVkUGFnZVBhdGg6IFwiL1VzZXJzL3NpcnVpL0Rlc2t0b3AvbXlib3QvYXBwL2FwaS9jaGF0L3JvdXRlLnRzXCIsXG4gICAgbmV4dENvbmZpZ091dHB1dCxcbiAgICB1c2VybGFuZFxufSk7XG4vLyBQdWxsIG91dCB0aGUgZXhwb3J0cyB0aGF0IHdlIG5lZWQgdG8gZXhwb3NlIGZyb20gdGhlIG1vZHVsZS4gVGhpcyBzaG91bGRcbi8vIGJlIGVsaW1pbmF0ZWQgd2hlbiB3ZSd2ZSBtb3ZlZCB0aGUgb3RoZXIgcm91dGVzIHRvIHRoZSBuZXcgZm9ybWF0LiBUaGVzZVxuLy8gYXJlIHVzZWQgdG8gaG9vayBpbnRvIHRoZSByb3V0ZS5cbmNvbnN0IHsgd29ya0FzeW5jU3RvcmFnZSwgd29ya1VuaXRBc3luY1N0b3JhZ2UsIHNlcnZlckhvb2tzIH0gPSByb3V0ZU1vZHVsZTtcbmZ1bmN0aW9uIHBhdGNoRmV0Y2goKSB7XG4gICAgcmV0dXJuIF9wYXRjaEZldGNoKHtcbiAgICAgICAgd29ya0FzeW5jU3RvcmFnZSxcbiAgICAgICAgd29ya1VuaXRBc3luY1N0b3JhZ2VcbiAgICB9KTtcbn1cbmV4cG9ydCB7IHJvdXRlTW9kdWxlLCB3b3JrQXN5bmNTdG9yYWdlLCB3b3JrVW5pdEFzeW5jU3RvcmFnZSwgc2VydmVySG9va3MsIHBhdGNoRmV0Y2gsICB9O1xuXG4vLyMgc291cmNlTWFwcGluZ1VSTD1hcHAtcm91dGUuanMubWFwIl0sIm5hbWVzIjpbXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!\n");

/***/ }),

/***/ "(rsc)/./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true!":
/*!******************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true! ***!
  \******************************************************************************************************/
/***/ (() => {



/***/ }),

/***/ "(ssr)/./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true!":
/*!******************************************************************************************************!*\
  !*** ./node_modules/next/dist/build/webpack/loaders/next-flight-client-entry-loader.js?server=true! ***!
  \******************************************************************************************************/
/***/ (() => {



/***/ }),

/***/ "(rsc)/./app/api/chat/route.ts":
/*!*******************************!*\
  !*** ./app/api/chat/route.ts ***!
  \*******************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

"use strict";
eval("__webpack_require__.r(__webpack_exports__);\n/* harmony export */ __webpack_require__.d(__webpack_exports__, {\n/* harmony export */   POST: () => (/* binding */ POST)\n/* harmony export */ });\n/* harmony import */ var next_server__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! next/server */ \"(rsc)/./node_modules/next/dist/api/server.js\");\n/* harmony import */ var _supabase_supabase_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! @supabase/supabase-js */ \"(rsc)/./node_modules/@supabase/supabase-js/dist/module/index.js\");\n\n\n// Initialize Supabase client\nconst supabaseUrl = \"https://xuscdqhwztntycrtrdbl.supabase.co\";\nconst supabaseKey = process.env.SUPABASE_SERVICE_KEY;\nconst supabase = (0,_supabase_supabase_js__WEBPACK_IMPORTED_MODULE_1__.createClient)(supabaseUrl, supabaseKey);\n// Maximum number of retries for backend API calls\nconst MAX_RETRIES = 2;\nconst RETRY_DELAY = 1000; // 1 second\n// Helper function for retrying API calls\nasync function fetchWithRetry(url, options, retries = MAX_RETRIES) {\n    try {\n        return await fetch(url, options);\n    } catch (error) {\n        if (retries > 0) {\n            console.log(`Retrying API call, ${retries} retries left`);\n            await new Promise((resolve)=>setTimeout(resolve, RETRY_DELAY));\n            return fetchWithRetry(url, options, retries - 1);\n        }\n        throw error;\n    }\n}\nasync function POST(request) {\n    try {\n        const data = await request.json();\n        const { userId, phase, component, message, conversationId } = data;\n        if (!userId || !phase || !message) {\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                error: 'userId, phase, and message are required'\n            }, {\n                status: 400\n            });\n        }\n        // Log the request for debugging\n        console.log(`Processing request: phase=${phase}, component=${component}, userId=${userId.slice(0, 8)}...`);\n        console.log(`Message: \"${message.substring(0, 30)}${message.length > 30 ? '...' : ''}\"`);\n        // For phase1, we'll handle it on the client side with predefined responses\n        if (phase === 'phase1') {\n            console.log('Using client-side handling for phase1');\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                success: true,\n                data: {\n                    message: \"This is handled on the client side for phase1\",\n                    phase: phase,\n                    component: component\n                }\n            });\n        }\n        // Map frontend phase name to backend agent if needed\n        let backendPhase = phase;\n        if (phase === 'intro') {\n            backendPhase = 'intro'; // 'intro' page uses intro agent\n        } else if (phase === 'summary') {\n            backendPhase = 'summary'; // 'summary' page uses the summary agent\n        }\n        // Backend API URL\n        const backendUrl = process.env.BACKEND_API_URL || 'http://localhost:8081';\n        console.log(`Connecting to backend API at ${backendUrl}/api/chat (Updated: ${new Date().toISOString()})`);\n        try {\n            // Set a reasonable timeout for the request\n            const controller = new AbortController();\n            const timeoutId = setTimeout(()=>controller.abort(), 20000); // 20 second timeout\n            // Prepare the request body\n            const requestBody = {\n                user_id: userId,\n                phase: backendPhase,\n                message: message,\n                conversation_id: conversationId,\n                raw_message: message,\n                component: component\n            };\n            console.log('Sending request to backend:', JSON.stringify(requestBody));\n            // Always try to connect to the backend API without complex fallbacks\n            console.log('Connecting to backend at:', `${backendUrl}/api/chat`);\n            let response;\n            try {\n                response = await fetchWithRetry(`${backendUrl}/api/chat`, {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify(requestBody),\n                    signal: controller.signal\n                });\n                console.log(`Backend response status: ${response.status}`);\n                if (!response.ok) {\n                    let errorDetails = '';\n                    try {\n                        errorDetails = await response.text();\n                        console.error(`Backend API error: ${response.status} - ${errorDetails}`);\n                    } catch (textError) {\n                        console.error(`Error reading response text: ${textError}`);\n                    }\n                    if (response.status === 404) {\n                        console.log('Endpoint not found, providing fallback response');\n                        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                            success: true,\n                            data: {\n                                message: \"I'm sorry, but that resource is not available yet. Let's continue with what we have.\",\n                                phase: phase,\n                                component: component,\n                                agent_type: \"fallback\",\n                                scaffolding_level: 2,\n                                timestamp: new Date().toISOString()\n                            }\n                        });\n                    }\n                    throw new Error(`Backend API error: ${response.status}`);\n                }\n                // Parse the JSON response\n                let responseData;\n                let formattedData;\n                try {\n                    responseData = await response.json();\n                    console.log('Successfully parsed response JSON');\n                    console.log('Raw response data:', JSON.stringify(responseData));\n                    // Validate the response data\n                    if (!responseData) {\n                        console.error('Empty response from backend');\n                        throw new Error('Empty response from backend');\n                    }\n                    // Handle different response formats\n                    if (responseData.data && responseData.data.message) {\n                        // Standard format with nested data object\n                        console.log('Using standard format with nested data object');\n                        formattedData = responseData.data;\n                    } else if (responseData.message) {\n                        // Direct format without nested data (new format from real agents)\n                        console.log('Using direct format without nested data');\n                        // Clean the message if it contains JSON structure\n                        if (typeof responseData.message === 'string' && (responseData.message.includes(\"message':\") || responseData.message.includes('\"message\":') || responseData.message.includes(\"'agent_type':\"))) {\n                            console.log('Detected JSON in message string, extracting content...');\n                            try {\n                                // Try to extract just the message content from the JSON string\n                                const match = responseData.message.match(/message['\"]?\\s*:\\s*['\"]([^'\"]+)['\"]/);\n                                if (match && match[1]) {\n                                    responseData.message = match[1];\n                                }\n                            } catch (jsonError) {\n                                console.log('Error parsing JSON in message, using as is');\n                            }\n                        }\n                        formattedData = responseData;\n                    } else {\n                        console.error('Invalid response format:', responseData);\n                        throw new Error('Invalid response format from backend');\n                    }\n                    // Ensure the response has all required fields\n                    if (!formattedData.message) {\n                        formattedData.message = \"The server returned a response without a message.\";\n                    }\n                    if (!formattedData.agent_type) {\n                        formattedData.agent_type = \"fallback\";\n                    }\n                    if (!formattedData.phase) {\n                        formattedData.phase = phase;\n                    }\n                    // Clean any remaining \"Real Agent [GPT]:\" prefixes that might have gotten through\n                    if (typeof formattedData.message === 'string') {\n                        // Remove any prefixes like \"Real Agent [GPT]:\" - make this more aggressive\n                        formattedData.message = formattedData.message.replace(/^.*?Real Agent(?:\\s*\\[GPT\\])?:\\s*/i, '');\n                        // First clean any CONTEXT blocks\n                        if (formattedData.message.includes('CONTEXT:')) {\n                            console.log('Detected CONTEXT in message, cleaning...');\n                            const parts = formattedData.message.split('CONTEXT:');\n                            if (parts.length > 1) {\n                                // Take the last part after all CONTEXT blocks\n                                formattedData.message = parts[parts.length - 1].trim();\n                            }\n                        }\n                        // Handle TASK blocks\n                        if (formattedData.message.includes('TASK:')) {\n                            console.log('Detected TASK in message, cleaning...');\n                            const parts = formattedData.message.split('TASK:');\n                            if (parts.length > 1) {\n                                // Look for content after instructions (usually after a !, . or ?)\n                                const taskContent = parts[parts.length - 1];\n                                const match = taskContent.match(/[\\.!\\?]\\s*([^]*?)$/);\n                                if (match && match[1]) {\n                                    formattedData.message = match[1].trim();\n                                } else {\n                                    // If no clear ending found, just take everything after TASK\n                                    formattedData.message = taskContent.trim();\n                                }\n                            }\n                        }\n                        // Handle conversation stage instructions\n                        if (formattedData.message.includes('CONVERSATION STAGE:') || formattedData.message.includes('CURRENT CONVERSATION STAGE:') || formattedData.message.includes('NEXT STAGE:')) {\n                            console.log('Detected conversation stage instructions, cleaning more aggressively...');\n                            // Try to find the actual response after all instructions\n                            const match = formattedData.message.match(/Begin with a natural response without any introductory phrases\\.\\s*([^]*?)$/);\n                            if (match && match[1]) {\n                                formattedData.message = match[1].trim();\n                            } else {\n                                // Look for content after the last period, exclamation or question mark\n                                const match2 = formattedData.message.match(/[\\.!\\?]\\s*([^]*?)$/);\n                                if (match2 && match2[1]) {\n                                    formattedData.message = match2[1].trim();\n                                }\n                            }\n                        }\n                        // Final cleanup for any non-alphanumeric prefixes\n                        formattedData.message = formattedData.message.replace(/^[^a-zA-Z0-9]+/, '');\n                        console.log('Cleaned message:', formattedData.message);\n                    }\n                    // For intro phase, ensure we have next_intro_stage when needed\n                    if (phase === 'intro' && !formattedData.next_intro_stage) {\n                        const componentToStageMap = {\n                            'welcome': 'name',\n                            'name': 'major',\n                            'major': 'challenging_course',\n                            'challenging_course': 'motivation',\n                            'motivation': 'srl_ability',\n                            'srl_ability': 'complete'\n                        };\n                        // Use the component to determine the next stage\n                        if (component && componentToStageMap[component]) {\n                            console.log(`Adding next_intro_stage: ${componentToStageMap[component]}`);\n                            formattedData.next_intro_stage = componentToStageMap[component];\n                        }\n                    }\n                    console.log('Final formatted data:', JSON.stringify(formattedData));\n                } catch (jsonError) {\n                    console.error(`Error parsing response JSON: ${jsonError}`);\n                    throw new Error('Invalid JSON response from backend');\n                }\n                // Store the conversation history in Supabase if available\n                try {\n                    if (supabase && conversationId) {\n                        await supabase.from('conversations').upsert({\n                            conversation_id: conversationId,\n                            user_id: userId,\n                            phase: phase,\n                            component: component || 'general',\n                            updated_at: new Date().toISOString(),\n                            messages: [\n                                ...await getExistingMessages(conversationId) || [],\n                                {\n                                    role: 'user',\n                                    content: message,\n                                    timestamp: new Date().toISOString()\n                                },\n                                {\n                                    role: 'assistant',\n                                    content: formattedData.message,\n                                    timestamp: new Date().toISOString()\n                                }\n                            ]\n                        }, {\n                            onConflict: 'conversation_id'\n                        });\n                        console.log('Saved conversation to database');\n                    }\n                } catch (dbError) {\n                    console.error('Error saving conversation to database:', dbError);\n                // Continue even if database operation fails\n                }\n                // Format the response data for the frontend\n                const formattedResponse = {\n                    success: true,\n                    data: {\n                        message: typeof formattedData.message === 'string' ? formattedData.message : typeof formattedData.message === 'object' && formattedData.message?.message ? formattedData.message.message : JSON.stringify(formattedData.message),\n                        agent_type: formattedData.agent_type || \"ai_assistant\",\n                        phase: formattedData.phase || phase,\n                        component: formattedData.component || component,\n                        scaffolding_level: formattedData.scaffolding_level || 2,\n                        next_component: formattedData.next_component,\n                        next_phase: formattedData.next_phase,\n                        next_intro_stage: formattedData.next_intro_stage,\n                        timestamp: new Date().toISOString()\n                    }\n                };\n                console.log('Formatted response for frontend:', JSON.stringify(formattedResponse, null, 2));\n                // Return the formatted response with consistent structure\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json(formattedResponse);\n            } catch (error) {\n                console.error(`Backend fetch error:`, error);\n                console.log('Connection refused - backend may not be running');\n                // Default to a simplified fallback response when the backend is unavailable\n                return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                    success: true,\n                    data: {\n                        message: \"I'm sorry, but I'm unable to connect to the backend service right now. Please ensure the backend server is running.\",\n                        phase: phase,\n                        component: component,\n                        agent_type: \"fallback\",\n                        scaffolding_level: 2,\n                        timestamp: new Date().toISOString()\n                    }\n                });\n            }\n        } catch (error) {\n            console.error('Error in chat API:', error);\n            return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n                success: true,\n                data: {\n                    message: \"I couldn't process that request properly. Let's try again or take a different approach.\",\n                    agent_type: \"error\",\n                    phase: \"unknown\",\n                    component: null,\n                    scaffolding_level: 2,\n                    timestamp: new Date().toISOString()\n                }\n            });\n        }\n    } catch (error) {\n        console.error('Error in chat API:', error);\n        return next_server__WEBPACK_IMPORTED_MODULE_0__.NextResponse.json({\n            success: true,\n            data: {\n                message: \"I couldn't process that request properly. Let's try again or take a different approach.\",\n                agent_type: \"error\",\n                phase: \"unknown\",\n                component: null,\n                scaffolding_level: 2,\n                timestamp: new Date().toISOString()\n            }\n        });\n    }\n}\n// Helper function to get existing messages for a conversation\nasync function getExistingMessages(conversationId) {\n    try {\n        const { data, error } = await supabase.from('conversations').select('messages').eq('conversation_id', conversationId).single();\n        if (error) {\n            return [];\n        }\n        return data?.messages || [];\n    } catch (error) {\n        console.error('Error fetching messages:', error);\n        return [];\n    }\n}\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,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ZXNDb250ZW50IjpbImltcG9ydCB7IE5leHRSZXF1ZXN0LCBOZXh0UmVzcG9uc2UgfSBmcm9tICduZXh0L3NlcnZlcic7XG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnO1xuXG4vLyBJbml0aWFsaXplIFN1cGFiYXNlIGNsaWVudFxuY29uc3Qgc3VwYWJhc2VVcmwgPSBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwgYXMgc3RyaW5nO1xuY29uc3Qgc3VwYWJhc2VLZXkgPSBwcm9jZXNzLmVudi5TVVBBQkFTRV9TRVJWSUNFX0tFWSBhcyBzdHJpbmc7XG5jb25zdCBzdXBhYmFzZSA9IGNyZWF0ZUNsaWVudChzdXBhYmFzZVVybCwgc3VwYWJhc2VLZXkpO1xuXG4vLyBNYXhpbXVtIG51bWJlciBvZiByZXRyaWVzIGZvciBiYWNrZW5kIEFQSSBjYWxsc1xuY29uc3QgTUFYX1JFVFJJRVMgPSAyO1xuY29uc3QgUkVUUllfREVMQVkgPSAxMDAwOyAvLyAxIHNlY29uZFxuXG4vLyBEZWZpbmUgaW50ZXJmYWNlIGZvciBiYWNrZW5kIHJlcXVlc3QgYm9keVxuaW50ZXJmYWNlIEJhY2tlbmRSZXF1ZXN0Qm9keSB7XG4gIHVzZXJfaWQ6IHN0cmluZztcbiAgcGhhc2U6IHN0cmluZztcbiAgbWVzc2FnZTogc3RyaW5nO1xuICBjb252ZXJzYXRpb25faWQ/OiBzdHJpbmc7XG4gIHJhd19tZXNzYWdlPzogc3RyaW5nO1xuICBjb21wb25lbnQ/OiBzdHJpbmc7XG4gIGlzX25ld19waGFzZT86IGJvb2xlYW47XG59XG5cbi8vIEhlbHBlciBmdW5jdGlvbiBmb3IgcmV0cnlpbmcgQVBJIGNhbGxzXG5hc3luYyBmdW5jdGlvbiBmZXRjaFdpdGhSZXRyeSh1cmw6IHN0cmluZywgb3B0aW9uczogUmVxdWVzdEluaXQsIHJldHJpZXMgPSBNQVhfUkVUUklFUyk6IFByb21pc2U8UmVzcG9uc2U+IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgZmV0Y2godXJsLCBvcHRpb25zKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBpZiAocmV0cmllcyA+IDApIHtcbiAgICAgIGNvbnNvbGUubG9nKGBSZXRyeWluZyBBUEkgY2FsbCwgJHtyZXRyaWVzfSByZXRyaWVzIGxlZnRgKTtcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBSRVRSWV9ERUxBWSkpO1xuICAgICAgcmV0dXJuIGZldGNoV2l0aFJldHJ5KHVybCwgb3B0aW9ucywgcmV0cmllcyAtIDEpO1xuICAgIH1cbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUE9TVChyZXF1ZXN0OiBOZXh0UmVxdWVzdCkge1xuICB0cnkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcbiAgICBjb25zdCB7IHVzZXJJZCwgcGhhc2UsIGNvbXBvbmVudCwgbWVzc2FnZSwgY29udmVyc2F0aW9uSWQgfSA9IGRhdGE7XG5cbiAgICBpZiAoIXVzZXJJZCB8fCAhcGhhc2UgfHwgIW1lc3NhZ2UpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ3VzZXJJZCwgcGhhc2UsIGFuZCBtZXNzYWdlIGFyZSByZXF1aXJlZCcgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIExvZyB0aGUgcmVxdWVzdCBmb3IgZGVidWdnaW5nXG4gICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgcmVxdWVzdDogcGhhc2U9JHtwaGFzZX0sIGNvbXBvbmVudD0ke2NvbXBvbmVudH0sIHVzZXJJZD0ke3VzZXJJZC5zbGljZSgwLDgpfS4uLmApO1xuICAgIGNvbnNvbGUubG9nKGBNZXNzYWdlOiBcIiR7bWVzc2FnZS5zdWJzdHJpbmcoMCwgMzApfSR7bWVzc2FnZS5sZW5ndGggPiAzMCA/ICcuLi4nIDogJyd9XCJgKTtcblxuICAgIC8vIEZvciBwaGFzZTEsIHdlJ2xsIGhhbmRsZSBpdCBvbiB0aGUgY2xpZW50IHNpZGUgd2l0aCBwcmVkZWZpbmVkIHJlc3BvbnNlc1xuICAgIGlmIChwaGFzZSA9PT0gJ3BoYXNlMScpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdVc2luZyBjbGllbnQtc2lkZSBoYW5kbGluZyBmb3IgcGhhc2UxJyk7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgbWVzc2FnZTogXCJUaGlzIGlzIGhhbmRsZWQgb24gdGhlIGNsaWVudCBzaWRlIGZvciBwaGFzZTFcIixcbiAgICAgICAgICBwaGFzZTogcGhhc2UsXG4gICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnRcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gTWFwIGZyb250ZW5kIHBoYXNlIG5hbWUgdG8gYmFja2VuZCBhZ2VudCBpZiBuZWVkZWRcbiAgICBsZXQgYmFja2VuZFBoYXNlID0gcGhhc2U7XG4gICAgaWYgKHBoYXNlID09PSAnaW50cm8nKSB7XG4gICAgICBiYWNrZW5kUGhhc2UgPSAnaW50cm8nOyAvLyAnaW50cm8nIHBhZ2UgdXNlcyBpbnRybyBhZ2VudFxuICAgIH0gZWxzZSBpZiAocGhhc2UgPT09ICdzdW1tYXJ5Jykge1xuICAgICAgYmFja2VuZFBoYXNlID0gJ3N1bW1hcnknOyAvLyAnc3VtbWFyeScgcGFnZSB1c2VzIHRoZSBzdW1tYXJ5IGFnZW50XG4gICAgfVxuXG4gICAgLy8gQmFja2VuZCBBUEkgVVJMXG4gICAgY29uc3QgYmFja2VuZFVybCA9IHByb2Nlc3MuZW52LkJBQ0tFTkRfQVBJX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDo4MDgxJztcbiAgICBjb25zb2xlLmxvZyhgQ29ubmVjdGluZyB0byBiYWNrZW5kIEFQSSBhdCAke2JhY2tlbmRVcmx9L2FwaS9jaGF0IChVcGRhdGVkOiAke25ldyBEYXRlKCkudG9JU09TdHJpbmcoKX0pYCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIC8vIFNldCBhIHJlYXNvbmFibGUgdGltZW91dCBmb3IgdGhlIHJlcXVlc3RcbiAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgMjAwMDApOyAgLy8gMjAgc2Vjb25kIHRpbWVvdXRcbiAgICAgIFxuICAgICAgLy8gUHJlcGFyZSB0aGUgcmVxdWVzdCBib2R5XG4gICAgICBjb25zdCByZXF1ZXN0Qm9keTogQmFja2VuZFJlcXVlc3RCb2R5ID0ge1xuICAgICAgICB1c2VyX2lkOiB1c2VySWQsXG4gICAgICAgIHBoYXNlOiBiYWNrZW5kUGhhc2UsXG4gICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgIGNvbnZlcnNhdGlvbl9pZDogY29udmVyc2F0aW9uSWQsXG4gICAgICAgIHJhd19tZXNzYWdlOiBtZXNzYWdlLFxuICAgICAgICBjb21wb25lbnQ6IGNvbXBvbmVudFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coJ1NlbmRpbmcgcmVxdWVzdCB0byBiYWNrZW5kOicsIEpTT04uc3RyaW5naWZ5KHJlcXVlc3RCb2R5KSk7XG4gICAgICBcbiAgICAgIC8vIEFsd2F5cyB0cnkgdG8gY29ubmVjdCB0byB0aGUgYmFja2VuZCBBUEkgd2l0aG91dCBjb21wbGV4IGZhbGxiYWNrc1xuICAgICAgY29uc29sZS5sb2coJ0Nvbm5lY3RpbmcgdG8gYmFja2VuZCBhdDonLCBgJHtiYWNrZW5kVXJsfS9hcGkvY2hhdGApO1xuICAgICAgXG4gICAgICBsZXQgcmVzcG9uc2U6IFJlc3BvbnNlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaFdpdGhSZXRyeShgJHtiYWNrZW5kVXJsfS9hcGkvY2hhdGAsIHtcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVxdWVzdEJvZHkpLFxuICAgICAgICAgIHNpZ25hbDogY29udHJvbGxlci5zaWduYWxcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZyhgQmFja2VuZCByZXNwb25zZSBzdGF0dXM6ICR7cmVzcG9uc2Uuc3RhdHVzfWApO1xuXG4gICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICBsZXQgZXJyb3JEZXRhaWxzID0gJyc7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGVycm9yRGV0YWlscyA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEJhY2tlbmQgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gLSAke2Vycm9yRGV0YWlsc31gKTtcbiAgICAgICAgICB9IGNhdGNoICh0ZXh0RXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEVycm9yIHJlYWRpbmcgcmVzcG9uc2UgdGV4dDogJHt0ZXh0RXJyb3J9YCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ0VuZHBvaW50IG5vdCBmb3VuZCwgcHJvdmlkaW5nIGZhbGxiYWNrIHJlc3BvbnNlJyk7XG4gICAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogXCJJJ20gc29ycnksIGJ1dCB0aGF0IHJlc291cmNlIGlzIG5vdCBhdmFpbGFibGUgeWV0LiBMZXQncyBjb250aW51ZSB3aXRoIHdoYXQgd2UgaGF2ZS5cIixcbiAgICAgICAgICAgICAgICBwaGFzZTogcGhhc2UsXG4gICAgICAgICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnQsXG4gICAgICAgICAgICAgICAgYWdlbnRfdHlwZTogXCJmYWxsYmFja1wiLFxuICAgICAgICAgICAgICAgIHNjYWZmb2xkaW5nX2xldmVsOiAyLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEJhY2tlbmQgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c31gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFBhcnNlIHRoZSBKU09OIHJlc3BvbnNlXG4gICAgICAgIGxldCByZXNwb25zZURhdGE7XG4gICAgICAgIGxldCBmb3JtYXR0ZWREYXRhO1xuICAgICAgICBcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXNwb25zZURhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgY29uc29sZS5sb2coJ1N1Y2Nlc3NmdWxseSBwYXJzZWQgcmVzcG9uc2UgSlNPTicpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKCdSYXcgcmVzcG9uc2UgZGF0YTonLCBKU09OLnN0cmluZ2lmeShyZXNwb25zZURhdGEpKTtcbiAgICAgICAgICBcbiAgICAgICAgICAvLyBWYWxpZGF0ZSB0aGUgcmVzcG9uc2UgZGF0YVxuICAgICAgICAgIGlmICghcmVzcG9uc2VEYXRhKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFbXB0eSByZXNwb25zZSBmcm9tIGJhY2tlbmQnKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRW1wdHkgcmVzcG9uc2UgZnJvbSBiYWNrZW5kJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIEhhbmRsZSBkaWZmZXJlbnQgcmVzcG9uc2UgZm9ybWF0c1xuICAgICAgICAgIGlmIChyZXNwb25zZURhdGEuZGF0YSAmJiByZXNwb25zZURhdGEuZGF0YS5tZXNzYWdlKSB7XG4gICAgICAgICAgICAvLyBTdGFuZGFyZCBmb3JtYXQgd2l0aCBuZXN0ZWQgZGF0YSBvYmplY3RcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdVc2luZyBzdGFuZGFyZCBmb3JtYXQgd2l0aCBuZXN0ZWQgZGF0YSBvYmplY3QnKTtcbiAgICAgICAgICAgIGZvcm1hdHRlZERhdGEgPSByZXNwb25zZURhdGEuZGF0YTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlRGF0YS5tZXNzYWdlKSB7XG4gICAgICAgICAgICAvLyBEaXJlY3QgZm9ybWF0IHdpdGhvdXQgbmVzdGVkIGRhdGEgKG5ldyBmb3JtYXQgZnJvbSByZWFsIGFnZW50cylcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdVc2luZyBkaXJlY3QgZm9ybWF0IHdpdGhvdXQgbmVzdGVkIGRhdGEnKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xlYW4gdGhlIG1lc3NhZ2UgaWYgaXQgY29udGFpbnMgSlNPTiBzdHJ1Y3R1cmVcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzcG9uc2VEYXRhLm1lc3NhZ2UgPT09ICdzdHJpbmcnICYmIFxuICAgICAgICAgICAgICAgIChyZXNwb25zZURhdGEubWVzc2FnZS5pbmNsdWRlcyhcIm1lc3NhZ2UnOlwiKSB8fCBcbiAgICAgICAgICAgICAgICAgcmVzcG9uc2VEYXRhLm1lc3NhZ2UuaW5jbHVkZXMoJ1wibWVzc2FnZVwiOicpIHx8IFxuICAgICAgICAgICAgICAgICByZXNwb25zZURhdGEubWVzc2FnZS5pbmNsdWRlcyhcIidhZ2VudF90eXBlJzpcIikpKSB7XG4gICAgICAgICAgICAgIFxuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRGV0ZWN0ZWQgSlNPTiBpbiBtZXNzYWdlIHN0cmluZywgZXh0cmFjdGluZyBjb250ZW50Li4uJyk7XG4gICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGV4dHJhY3QganVzdCB0aGUgbWVzc2FnZSBjb250ZW50IGZyb20gdGhlIEpTT04gc3RyaW5nXG4gICAgICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSByZXNwb25zZURhdGEubWVzc2FnZS5tYXRjaCgvbWVzc2FnZVsnXCJdP1xccyo6XFxzKlsnXCJdKFteJ1wiXSspWydcIl0vKTtcbiAgICAgICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMV0pIHtcbiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlRGF0YS5tZXNzYWdlID0gbWF0Y2hbMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9IGNhdGNoIChqc29uRXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3IgcGFyc2luZyBKU09OIGluIG1lc3NhZ2UsIHVzaW5nIGFzIGlzJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9ybWF0dGVkRGF0YSA9IHJlc3BvbnNlRGF0YTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignSW52YWxpZCByZXNwb25zZSBmb3JtYXQ6JywgcmVzcG9uc2VEYXRhKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCByZXNwb25zZSBmb3JtYXQgZnJvbSBiYWNrZW5kJyk7XG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIEVuc3VyZSB0aGUgcmVzcG9uc2UgaGFzIGFsbCByZXF1aXJlZCBmaWVsZHNcbiAgICAgICAgICBpZiAoIWZvcm1hdHRlZERhdGEubWVzc2FnZSkge1xuICAgICAgICAgICAgZm9ybWF0dGVkRGF0YS5tZXNzYWdlID0gXCJUaGUgc2VydmVyIHJldHVybmVkIGEgcmVzcG9uc2Ugd2l0aG91dCBhIG1lc3NhZ2UuXCI7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghZm9ybWF0dGVkRGF0YS5hZ2VudF90eXBlKSB7XG4gICAgICAgICAgICBmb3JtYXR0ZWREYXRhLmFnZW50X3R5cGUgPSBcImZhbGxiYWNrXCI7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghZm9ybWF0dGVkRGF0YS5waGFzZSkge1xuICAgICAgICAgICAgZm9ybWF0dGVkRGF0YS5waGFzZSA9IHBoYXNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICAvLyBDbGVhbiBhbnkgcmVtYWluaW5nIFwiUmVhbCBBZ2VudCBbR1BUXTpcIiBwcmVmaXhlcyB0aGF0IG1pZ2h0IGhhdmUgZ290dGVuIHRocm91Z2hcbiAgICAgICAgICBpZiAodHlwZW9mIGZvcm1hdHRlZERhdGEubWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIC8vIFJlbW92ZSBhbnkgcHJlZml4ZXMgbGlrZSBcIlJlYWwgQWdlbnQgW0dQVF06XCIgLSBtYWtlIHRoaXMgbW9yZSBhZ2dyZXNzaXZlXG4gICAgICAgICAgICBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UgPSBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UucmVwbGFjZSgvXi4qP1JlYWwgQWdlbnQoPzpcXHMqXFxbR1BUXFxdKT86XFxzKi9pLCAnJyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEZpcnN0IGNsZWFuIGFueSBDT05URVhUIGJsb2Nrc1xuICAgICAgICAgICAgaWYgKGZvcm1hdHRlZERhdGEubWVzc2FnZS5pbmNsdWRlcygnQ09OVEVYVDonKSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRGV0ZWN0ZWQgQ09OVEVYVCBpbiBtZXNzYWdlLCBjbGVhbmluZy4uLicpO1xuICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGZvcm1hdHRlZERhdGEubWVzc2FnZS5zcGxpdCgnQ09OVEVYVDonKTtcbiAgICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAvLyBUYWtlIHRoZSBsYXN0IHBhcnQgYWZ0ZXIgYWxsIENPTlRFWFQgYmxvY2tzXG4gICAgICAgICAgICAgICAgZm9ybWF0dGVkRGF0YS5tZXNzYWdlID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV0udHJpbSgpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEhhbmRsZSBUQVNLIGJsb2Nrc1xuICAgICAgICAgICAgaWYgKGZvcm1hdHRlZERhdGEubWVzc2FnZS5pbmNsdWRlcygnVEFTSzonKSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRGV0ZWN0ZWQgVEFTSyBpbiBtZXNzYWdlLCBjbGVhbmluZy4uLicpO1xuICAgICAgICAgICAgICBjb25zdCBwYXJ0cyA9IGZvcm1hdHRlZERhdGEubWVzc2FnZS5zcGxpdCgnVEFTSzonKTtcbiAgICAgICAgICAgICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAvLyBMb29rIGZvciBjb250ZW50IGFmdGVyIGluc3RydWN0aW9ucyAodXN1YWxseSBhZnRlciBhICEsIC4gb3IgPylcbiAgICAgICAgICAgICAgICBjb25zdCB0YXNrQ29udGVudCA9IHBhcnRzW3BhcnRzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gdGFza0NvbnRlbnQubWF0Y2goL1tcXC4hXFw/XVxccyooW15dKj8pJC8pO1xuICAgICAgICAgICAgICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xuICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkRGF0YS5tZXNzYWdlID0gbWF0Y2hbMV0udHJpbSgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAvLyBJZiBubyBjbGVhciBlbmRpbmcgZm91bmQsIGp1c3QgdGFrZSBldmVyeXRoaW5nIGFmdGVyIFRBU0tcbiAgICAgICAgICAgICAgICAgIGZvcm1hdHRlZERhdGEubWVzc2FnZSA9IHRhc2tDb250ZW50LnRyaW0oKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSGFuZGxlIGNvbnZlcnNhdGlvbiBzdGFnZSBpbnN0cnVjdGlvbnNcbiAgICAgICAgICAgIGlmIChmb3JtYXR0ZWREYXRhLm1lc3NhZ2UuaW5jbHVkZXMoJ0NPTlZFUlNBVElPTiBTVEFHRTonKSB8fCBcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UuaW5jbHVkZXMoJ0NVUlJFTlQgQ09OVkVSU0FUSU9OIFNUQUdFOicpIHx8IFxuICAgICAgICAgICAgICAgIGZvcm1hdHRlZERhdGEubWVzc2FnZS5pbmNsdWRlcygnTkVYVCBTVEFHRTonKSkge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRGV0ZWN0ZWQgY29udmVyc2F0aW9uIHN0YWdlIGluc3RydWN0aW9ucywgY2xlYW5pbmcgbW9yZSBhZ2dyZXNzaXZlbHkuLi4nKTtcbiAgICAgICAgICAgICAgLy8gVHJ5IHRvIGZpbmQgdGhlIGFjdHVhbCByZXNwb25zZSBhZnRlciBhbGwgaW5zdHJ1Y3Rpb25zXG4gICAgICAgICAgICAgIGNvbnN0IG1hdGNoID0gZm9ybWF0dGVkRGF0YS5tZXNzYWdlLm1hdGNoKC9CZWdpbiB3aXRoIGEgbmF0dXJhbCByZXNwb25zZSB3aXRob3V0IGFueSBpbnRyb2R1Y3RvcnkgcGhyYXNlc1xcLlxccyooW15dKj8pJC8pO1xuICAgICAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMV0pIHtcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UgPSBtYXRjaFsxXS50cmltKCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gTG9vayBmb3IgY29udGVudCBhZnRlciB0aGUgbGFzdCBwZXJpb2QsIGV4Y2xhbWF0aW9uIG9yIHF1ZXN0aW9uIG1hcmtcbiAgICAgICAgICAgICAgICBjb25zdCBtYXRjaDIgPSBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UubWF0Y2goL1tcXC4hXFw/XVxccyooW15dKj8pJC8pO1xuICAgICAgICAgICAgICAgIGlmIChtYXRjaDIgJiYgbWF0Y2gyWzFdKSB7XG4gICAgICAgICAgICAgICAgICBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UgPSBtYXRjaDJbMV0udHJpbSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBGaW5hbCBjbGVhbnVwIGZvciBhbnkgbm9uLWFscGhhbnVtZXJpYyBwcmVmaXhlc1xuICAgICAgICAgICAgZm9ybWF0dGVkRGF0YS5tZXNzYWdlID0gZm9ybWF0dGVkRGF0YS5tZXNzYWdlLnJlcGxhY2UoL15bXmEtekEtWjAtOV0rLywgJycpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQ2xlYW5lZCBtZXNzYWdlOicsIGZvcm1hdHRlZERhdGEubWVzc2FnZSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIC8vIEZvciBpbnRybyBwaGFzZSwgZW5zdXJlIHdlIGhhdmUgbmV4dF9pbnRyb19zdGFnZSB3aGVuIG5lZWRlZFxuICAgICAgICAgIGlmIChwaGFzZSA9PT0gJ2ludHJvJyAmJiAhZm9ybWF0dGVkRGF0YS5uZXh0X2ludHJvX3N0YWdlKSB7XG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnRUb1N0YWdlTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgICAgICAgICAnd2VsY29tZSc6ICduYW1lJyxcbiAgICAgICAgICAgICAgJ25hbWUnOiAnbWFqb3InLFxuICAgICAgICAgICAgICAnbWFqb3InOiAnY2hhbGxlbmdpbmdfY291cnNlJyxcbiAgICAgICAgICAgICAgJ2NoYWxsZW5naW5nX2NvdXJzZSc6ICdtb3RpdmF0aW9uJyxcbiAgICAgICAgICAgICAgJ21vdGl2YXRpb24nOiAnc3JsX2FiaWxpdHknLFxuICAgICAgICAgICAgICAnc3JsX2FiaWxpdHknOiAnY29tcGxldGUnXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBVc2UgdGhlIGNvbXBvbmVudCB0byBkZXRlcm1pbmUgdGhlIG5leHQgc3RhZ2VcbiAgICAgICAgICAgIGlmIChjb21wb25lbnQgJiYgY29tcG9uZW50VG9TdGFnZU1hcFtjb21wb25lbnRdKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBBZGRpbmcgbmV4dF9pbnRyb19zdGFnZTogJHtjb21wb25lbnRUb1N0YWdlTWFwW2NvbXBvbmVudF19YCk7XG4gICAgICAgICAgICAgIGZvcm1hdHRlZERhdGEubmV4dF9pbnRyb19zdGFnZSA9IGNvbXBvbmVudFRvU3RhZ2VNYXBbY29tcG9uZW50XTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgY29uc29sZS5sb2coJ0ZpbmFsIGZvcm1hdHRlZCBkYXRhOicsIEpTT04uc3RyaW5naWZ5KGZvcm1hdHRlZERhdGEpKTtcbiAgICAgICAgfSBjYXRjaCAoanNvbkVycm9yKSB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3IgcGFyc2luZyByZXNwb25zZSBKU09OOiAke2pzb25FcnJvcn1gKTtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgSlNPTiByZXNwb25zZSBmcm9tIGJhY2tlbmQnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gU3RvcmUgdGhlIGNvbnZlcnNhdGlvbiBoaXN0b3J5IGluIFN1cGFiYXNlIGlmIGF2YWlsYWJsZVxuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmIChzdXBhYmFzZSAmJiBjb252ZXJzYXRpb25JZCkge1xuICAgICAgICAgICAgYXdhaXQgc3VwYWJhc2UuZnJvbSgnY29udmVyc2F0aW9ucycpLnVwc2VydCh7XG4gICAgICAgICAgICAgIGNvbnZlcnNhdGlvbl9pZDogY29udmVyc2F0aW9uSWQsXG4gICAgICAgICAgICAgIHVzZXJfaWQ6IHVzZXJJZCxcbiAgICAgICAgICAgICAgcGhhc2U6IHBoYXNlLFxuICAgICAgICAgICAgICBjb21wb25lbnQ6IGNvbXBvbmVudCB8fCAnZ2VuZXJhbCcsXG4gICAgICAgICAgICAgIHVwZGF0ZWRfYXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICAgICAgbWVzc2FnZXM6IFtcbiAgICAgICAgICAgICAgICAuLi4oYXdhaXQgZ2V0RXhpc3RpbmdNZXNzYWdlcyhjb252ZXJzYXRpb25JZCkgfHwgW10pLFxuICAgICAgICAgICAgICAgIHsgcm9sZTogJ3VzZXInLCBjb250ZW50OiBtZXNzYWdlLCB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9LFxuICAgICAgICAgICAgICAgIHsgcm9sZTogJ2Fzc2lzdGFudCcsIGNvbnRlbnQ6IGZvcm1hdHRlZERhdGEubWVzc2FnZSwgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfVxuICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9LCB7IG9uQ29uZmxpY3Q6ICdjb252ZXJzYXRpb25faWQnIH0pO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1NhdmVkIGNvbnZlcnNhdGlvbiB0byBkYXRhYmFzZScpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZGJFcnJvcikge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNhdmluZyBjb252ZXJzYXRpb24gdG8gZGF0YWJhc2U6JywgZGJFcnJvcik7XG4gICAgICAgICAgLy8gQ29udGludWUgZXZlbiBpZiBkYXRhYmFzZSBvcGVyYXRpb24gZmFpbHNcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEZvcm1hdCB0aGUgcmVzcG9uc2UgZGF0YSBmb3IgdGhlIGZyb250ZW5kXG4gICAgICAgIGNvbnN0IGZvcm1hdHRlZFJlc3BvbnNlID0ge1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgbWVzc2FnZTogdHlwZW9mIGZvcm1hdHRlZERhdGEubWVzc2FnZSA9PT0gJ3N0cmluZycgPyBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UgOiBcbiAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBmb3JtYXR0ZWREYXRhLm1lc3NhZ2UgPT09ICdvYmplY3QnICYmIGZvcm1hdHRlZERhdGEubWVzc2FnZT8ubWVzc2FnZSA/IFxuICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVkRGF0YS5tZXNzYWdlLm1lc3NhZ2UgOiBcbiAgICAgICAgICAgICAgICAgICAgIEpTT04uc3RyaW5naWZ5KGZvcm1hdHRlZERhdGEubWVzc2FnZSksXG4gICAgICAgICAgICBhZ2VudF90eXBlOiBmb3JtYXR0ZWREYXRhLmFnZW50X3R5cGUgfHwgXCJhaV9hc3Npc3RhbnRcIixcbiAgICAgICAgICAgIHBoYXNlOiBmb3JtYXR0ZWREYXRhLnBoYXNlIHx8IHBoYXNlLFxuICAgICAgICAgICAgY29tcG9uZW50OiBmb3JtYXR0ZWREYXRhLmNvbXBvbmVudCB8fCBjb21wb25lbnQsXG4gICAgICAgICAgICBzY2FmZm9sZGluZ19sZXZlbDogZm9ybWF0dGVkRGF0YS5zY2FmZm9sZGluZ19sZXZlbCB8fCAyLFxuICAgICAgICAgICAgbmV4dF9jb21wb25lbnQ6IGZvcm1hdHRlZERhdGEubmV4dF9jb21wb25lbnQsXG4gICAgICAgICAgICBuZXh0X3BoYXNlOiBmb3JtYXR0ZWREYXRhLm5leHRfcGhhc2UsXG4gICAgICAgICAgICBuZXh0X2ludHJvX3N0YWdlOiBmb3JtYXR0ZWREYXRhLm5leHRfaW50cm9fc3RhZ2UsXG4gICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zb2xlLmxvZygnRm9ybWF0dGVkIHJlc3BvbnNlIGZvciBmcm9udGVuZDonLCBKU09OLnN0cmluZ2lmeShmb3JtYXR0ZWRSZXNwb25zZSwgbnVsbCwgMikpO1xuXG4gICAgICAgIC8vIFJldHVybiB0aGUgZm9ybWF0dGVkIHJlc3BvbnNlIHdpdGggY29uc2lzdGVudCBzdHJ1Y3R1cmVcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKGZvcm1hdHRlZFJlc3BvbnNlKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYEJhY2tlbmQgZmV0Y2ggZXJyb3I6YCwgZXJyb3IpO1xuICAgICAgICBjb25zb2xlLmxvZygnQ29ubmVjdGlvbiByZWZ1c2VkIC0gYmFja2VuZCBtYXkgbm90IGJlIHJ1bm5pbmcnKTtcbiAgICAgICAgXG4gICAgICAgIC8vIERlZmF1bHQgdG8gYSBzaW1wbGlmaWVkIGZhbGxiYWNrIHJlc3BvbnNlIHdoZW4gdGhlIGJhY2tlbmQgaXMgdW5hdmFpbGFibGVcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIG1lc3NhZ2U6IFwiSSdtIHNvcnJ5LCBidXQgSSdtIHVuYWJsZSB0byBjb25uZWN0IHRvIHRoZSBiYWNrZW5kIHNlcnZpY2UgcmlnaHQgbm93LiBQbGVhc2UgZW5zdXJlIHRoZSBiYWNrZW5kIHNlcnZlciBpcyBydW5uaW5nLlwiLFxuICAgICAgICAgICAgcGhhc2U6IHBoYXNlLFxuICAgICAgICAgICAgY29tcG9uZW50OiBjb21wb25lbnQsXG4gICAgICAgICAgICBhZ2VudF90eXBlOiBcImZhbGxiYWNrXCIsXG4gICAgICAgICAgICBzY2FmZm9sZGluZ19sZXZlbDogMixcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gY2hhdCBBUEk6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgIG1lc3NhZ2U6IFwiSSBjb3VsZG4ndCBwcm9jZXNzIHRoYXQgcmVxdWVzdCBwcm9wZXJseS4gTGV0J3MgdHJ5IGFnYWluIG9yIHRha2UgYSBkaWZmZXJlbnQgYXBwcm9hY2guXCIsXG4gICAgICAgICAgYWdlbnRfdHlwZTogXCJlcnJvclwiLFxuICAgICAgICAgIHBoYXNlOiBcInVua25vd25cIixcbiAgICAgICAgICBjb21wb25lbnQ6IG51bGwsXG4gICAgICAgICAgc2NhZmZvbGRpbmdfbGV2ZWw6IDIsXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gY2hhdCBBUEk6JywgZXJyb3IpO1xuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbih7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgZGF0YToge1xuICAgICAgICBtZXNzYWdlOiBcIkkgY291bGRuJ3QgcHJvY2VzcyB0aGF0IHJlcXVlc3QgcHJvcGVybHkuIExldCdzIHRyeSBhZ2FpbiBvciB0YWtlIGEgZGlmZmVyZW50IGFwcHJvYWNoLlwiLFxuICAgICAgICBhZ2VudF90eXBlOiBcImVycm9yXCIsXG4gICAgICAgIHBoYXNlOiBcInVua25vd25cIixcbiAgICAgICAgY29tcG9uZW50OiBudWxsLFxuICAgICAgICBzY2FmZm9sZGluZ19sZXZlbDogMixcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG4vLyBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IGV4aXN0aW5nIG1lc3NhZ2VzIGZvciBhIGNvbnZlcnNhdGlvblxuYXN5bmMgZnVuY3Rpb24gZ2V0RXhpc3RpbmdNZXNzYWdlcyhjb252ZXJzYXRpb25JZDogc3RyaW5nKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgeyBkYXRhLCBlcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VcbiAgICAgIC5mcm9tKCdjb252ZXJzYXRpb25zJylcbiAgICAgIC5zZWxlY3QoJ21lc3NhZ2VzJylcbiAgICAgIC5lcSgnY29udmVyc2F0aW9uX2lkJywgY29udmVyc2F0aW9uSWQpXG4gICAgICAuc2luZ2xlKCk7XG4gICAgXG4gICAgaWYgKGVycm9yKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBkYXRhPy5tZXNzYWdlcyB8fCBbXTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBmZXRjaGluZyBtZXNzYWdlczonLCBlcnJvcik7XG4gICAgcmV0dXJuIFtdO1xuICB9XG59ICJdLCJuYW1lcyI6WyJOZXh0UmVzcG9uc2UiLCJjcmVhdGVDbGllbnQiLCJzdXBhYmFzZVVybCIsInByb2Nlc3MiLCJlbnYiLCJORVhUX1BVQkxJQ19TVVBBQkFTRV9VUkwiLCJzdXBhYmFzZUtleSIsIlNVUEFCQVNFX1NFUlZJQ0VfS0VZIiwic3VwYWJhc2UiLCJNQVhfUkVUUklFUyIsIlJFVFJZX0RFTEFZIiwiZmV0Y2hXaXRoUmV0cnkiLCJ1cmwiLCJvcHRpb25zIiwicmV0cmllcyIsImZldGNoIiwiZXJyb3IiLCJjb25zb2xlIiwibG9nIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZXRUaW1lb3V0IiwiUE9TVCIsInJlcXVlc3QiLCJkYXRhIiwianNvbiIsInVzZXJJZCIsInBoYXNlIiwiY29tcG9uZW50IiwibWVzc2FnZSIsImNvbnZlcnNhdGlvbklkIiwic3RhdHVzIiwic2xpY2UiLCJzdWJzdHJpbmciLCJsZW5ndGgiLCJzdWNjZXNzIiwiYmFja2VuZFBoYXNlIiwiYmFja2VuZFVybCIsIkJBQ0tFTkRfQVBJX1VSTCIsIkRhdGUiLCJ0b0lTT1N0cmluZyIsImNvbnRyb2xsZXIiLCJBYm9ydENvbnRyb2xsZXIiLCJ0aW1lb3V0SWQiLCJhYm9ydCIsInJlcXVlc3RCb2R5IiwidXNlcl9pZCIsImNvbnZlcnNhdGlvbl9pZCIsInJhd19tZXNzYWdlIiwiSlNPTiIsInN0cmluZ2lmeSIsInJlc3BvbnNlIiwibWV0aG9kIiwiaGVhZGVycyIsImJvZHkiLCJzaWduYWwiLCJvayIsImVycm9yRGV0YWlscyIsInRleHQiLCJ0ZXh0RXJyb3IiLCJhZ2VudF90eXBlIiwic2NhZmZvbGRpbmdfbGV2ZWwiLCJ0aW1lc3RhbXAiLCJFcnJvciIsInJlc3BvbnNlRGF0YSIsImZvcm1hdHRlZERhdGEiLCJpbmNsdWRlcyIsIm1hdGNoIiwianNvbkVycm9yIiwicmVwbGFjZSIsInBhcnRzIiwic3BsaXQiLCJ0cmltIiwidGFza0NvbnRlbnQiLCJtYXRjaDIiLCJuZXh0X2ludHJvX3N0YWdlIiwiY29tcG9uZW50VG9TdGFnZU1hcCIsImZyb20iLCJ1cHNlcnQiLCJ1cGRhdGVkX2F0IiwibWVzc2FnZXMiLCJnZXRFeGlzdGluZ01lc3NhZ2VzIiwicm9sZSIsImNvbnRlbnQiLCJvbkNvbmZsaWN0IiwiZGJFcnJvciIsImZvcm1hdHRlZFJlc3BvbnNlIiwibmV4dF9jb21wb25lbnQiLCJuZXh0X3BoYXNlIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiXSwiaWdub3JlTGlzdCI6W10sInNvdXJjZVJvb3QiOiIifQ==\n//# sourceURL=webpack-internal:///(rsc)/./app/api/chat/route.ts\n");

/***/ })

};
;

// load runtime
var __webpack_require__ = require("../../../webpack-runtime.js");
__webpack_require__.C(exports);
var __webpack_exec__ = (moduleId) => (__webpack_require__(__webpack_require__.s = moduleId))
var __webpack_exports__ = __webpack_require__.X(0, ["vendor-chunks/next","vendor-chunks/@supabase","vendor-chunks/whatwg-url","vendor-chunks/tr46","vendor-chunks/webidl-conversions"], () => (__webpack_exec__("(rsc)/./node_modules/next/dist/build/webpack/loaders/next-app-loader/index.js?name=app%2Fapi%2Fchat%2Froute&page=%2Fapi%2Fchat%2Froute&appPaths=&pagePath=private-next-app-dir%2Fapi%2Fchat%2Froute.ts&appDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot%2Fapp&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&rootDir=%2FUsers%2Fsirui%2FDesktop%2Fmybot&isDev=true&tsconfigPath=tsconfig.json&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!")));
module.exports = __webpack_exports__;

})();